const g="/assets/images/others/placeholder.jpg";let l="all";document.addEventListener("DOMContentLoaded",function(){b(),p()});function p(){const e=document.querySelectorAll(".platform-tab");e.forEach(n=>{n.addEventListener("click",o=>{o.preventDefault(),e.forEach(t=>t.classList.remove("active")),n.classList.add("active"),l=n.dataset.platform,C(l)})})}function b(){var o;if(typeof window.Echo>"u"){console.warn("Pusher/Echo not available, real-time features disabled");return}console.log("Initializing Pusher listeners...");const e=(o=window.Echo.connector)==null?void 0:o.pusher;e&&(e.connection.bind("state_change",t=>{console.log("Pusher state change:",t.current)}),e.connection.bind("connected",()=>{console.log("Pusher connected")}),e.connection.bind("error",t=>{console.error("Pusher connection error:",t)}));const n=window.Echo.private("inbox");console.log("Subscribing to private channel: inbox"),n.listen(".MessageReceived",t=>{console.log("MessageReceived event:",t),h(t)}).listen(".ConversationStatusChanged",t=>{console.log("ConversationStatusChanged event:",t),y(t)}),n.subscribed(()=>{console.log("Subscribed to private-inbox channel")}),n.error(t=>{console.error("Pusher subscription error:",t)}),console.log("Pusher listeners initialized")}function h(e){const n=e.message,o=e.conversation,t=e.customer;console.log("Incoming payload:",{messageId:n==null?void 0:n.id,conversationId:o==null?void 0:o.id,customerName:t==null?void 0:t.name}),v(o,n),currentConversationId===o.id&&(appendMessage(n),n.sender_type!=="admin"&&m(o.id)),n.sender_type!=="admin"&&f(`New message from ${(t==null?void 0:t.name)||"Customer"}`,n.content.substring(0,50))}function v(e,n){var d;const o=document.querySelector(`.conversation-item[data-conversation-id="${e.id}"]`);if(console.log("Update conversation list:",{conversationId:e==null?void 0:e.id,hasItem:!!o,unread:e==null?void 0:e.unread_count}),!o){u(e);return}const t=document.getElementById("conversation-list");t.insertBefore(o,t.firstChild);const s=n||((d=e.messages)==null?void 0:d[e.messages.length-1]);if(s){const i=o.querySelector(".text-truncate");i&&(i.textContent=s.content)}const a=o.querySelector(".badge"),r=o.querySelector(".conversation-meta");if(e.unread_count>0)if(a)a.textContent=e.unread_count;else{const i=document.createElement("div");i.className="badge rounded-pill bg-primary ms-auto",i.textContent=e.unread_count,r&&r.appendChild(i)}else a&&a.remove();c()}function u(e){var a,r;const n=document.getElementById("conversation-list");if(!n)return;const o=(a=e.messages)==null?void 0:a[e.messages.length-1],t=((r=e.customer)==null?void 0:r.name)||"Unknown Customer",s=document.createElement("li");s.className="chat-item pe-1 conversation-item",s.setAttribute("data-conversation-id",e.id),s.onclick=()=>selectConversation(e.id),s.innerHTML=`
        <a href="javascript:;" class="d-flex align-items-center">
            <figure class="mb-0 me-2">
                <img src="${g}" class="img-xs rounded-circle" alt="user">
                <div class="status online"></div>
            </figure>
            <div class="d-flex justify-content-between flex-grow-1 border-bottom">
                <div>
                    <p class="text-body fw-bolder">${t}</p>
                    <p class="text-muted tx-13 text-truncate">${(o==null?void 0:o.content)||"No messages yet"}</p>
                </div>
                <div class="d-flex flex-column align-items-end conversation-meta">
                    <p class="text-muted tx-13 mb-1"></p>
                    ${e.unread_count>0?`<div class="badge rounded-pill bg-primary ms-auto">${e.unread_count}</div>`:""}
                </div>
            </div>
        </a>
    `,n.insertBefore(s,n.firstChild),c()}function C(e){var t;const n=document.getElementById("conversation-list");if(!n){console.warn("Conversation list element not found");return}n.innerHTML="";const o=e==="all"?"/api/conversations":`/api/conversations?platform=${encodeURIComponent(e)}`;fetch(o,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.content)||""}}).then(s=>{if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return s.json()}).then(s=>{const a=s.data||s;if(Array.isArray(a)&&a.length===0){n.innerHTML='<li class="p-3 text-center text-muted">No conversations found</li>';return}a.forEach(r=>{u(r)}),console.log(`Loaded ${a.length} conversations for platform: ${e}`)}).catch(s=>{console.error(`Error loading conversations for platform ${e}:`,s),n.innerHTML='<li class="p-3 text-center text-muted">Error loading conversations</li>'})}function c(){const e=document.getElementById("sidebar-inbox-badge");if(!e)return;const n=document.querySelectorAll("#conversation-list .badge"),o=Array.from(n).reduce((t,s)=>{const a=parseInt(s.textContent,10);return t+(Number.isNaN(a)?0:a)},0);e.textContent=o,e.dataset.unreadCount=o,e.classList.toggle("d-none",o===0)}function y(e){const n=e.conversation;console.log("Conversation status changed:",n.status),currentConversationId,n.id}function m(e){fetch(`/api/conversations/${e}/read`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(()=>c()).catch(n=>console.error("Error marking as read:",n))}function f(e,n){const o=document.querySelector(".toast-container")||document.querySelector(".position-fixed");if(!o)return;if(typeof bootstrap>"u"||!bootstrap.Toast){console.warn("Bootstrap Toast not available. Skipping notification.");return}const t=document.createElement("div");t.className="toast align-items-center text-white bg-primary border-0 shadow-lg",t.setAttribute("role","status"),t.setAttribute("aria-live","assertive"),t.setAttribute("aria-atomic","true"),t.innerHTML=`
        <div class="d-flex">
            <div class="toast-body">
                <strong>${e}</strong>
                <p class="mb-0 text-truncate">${n}</p>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `,o.appendChild(t),new bootstrap.Toast(t).show(),t.addEventListener("hidden.bs.toast",()=>t.remove())}window.showNotification=f;window.updateSidebarUnreadBadge=c;window.markConversationAsRead=m;
