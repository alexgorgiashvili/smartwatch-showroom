const v="/assets/images/others/placeholder.jpg",y="/assets/images/others/placeholder.jpg";let f="all",l=!1,g=!1;document.addEventListener("DOMContentLoaded",function(){I(),N(),C()});function C(){const e=document.querySelectorAll(".platform-tab");e.forEach(n=>{n.addEventListener("click",o=>{o.preventDefault(),e.forEach(t=>t.classList.remove("active")),n.classList.add("active"),f=n.dataset.platform,E(f)})})}function N(){var o;if(typeof window.Echo>"u"){console.warn("Pusher/Echo not available, real-time features disabled");return}console.log("Initializing Pusher listeners...");const e=(o=window.Echo.connector)==null?void 0:o.pusher;e&&(e.connection.bind("state_change",t=>{console.log("Pusher state change:",t.current)}),e.connection.bind("connected",()=>{console.log("Pusher connected")}),e.connection.bind("error",t=>{console.error("Pusher connection error:",t)}));const n=window.Echo.private("inbox");console.log("Subscribing to private channel: inbox"),n.listen(".MessageReceived",t=>{console.log("MessageReceived event:",t),x(t)}).listen(".ConversationStatusChanged",t=>{console.log("ConversationStatusChanged event:",t),T(t)}),n.subscribed(()=>{console.log("Subscribed to private-inbox channel")}),n.error(t=>{console.error("Pusher subscription error:",t)}),console.log("Pusher listeners initialized")}async function x(e){const n=e.message,o=e.conversation,t=e.customer,s=(t==null?void 0:t.name)||"Customer",i=((n==null?void 0:n.content)||"").substring(0,50);console.log("Incoming payload:",{messageId:n==null?void 0:n.id,conversationId:o==null?void 0:o.id,customerName:t==null?void 0:t.name}),S(o,n);const a=Number(window.currentConversationId||0)||null;if(a&&Number(o==null?void 0:o.id)===a&&(typeof window.appendMessage=="function"&&window.appendMessage(n),n.sender_type!=="admin"&&h(o.id)),n.sender_type!=="admin"){const c=`New message from ${s}`;m(c,i),await L(c,i,o==null?void 0:o.id)}}function S(e,n){var c;const o=document.querySelector(`.conversation-item[data-conversation-id="${e.id}"]`);if(console.log("Update conversation list:",{conversationId:e==null?void 0:e.id,hasItem:!!o,unread:e==null?void 0:e.unread_count}),!o){p(e);return}const t=document.getElementById("conversation-list");t.insertBefore(o,t.firstChild);const s=n||((c=e.messages)==null?void 0:c[e.messages.length-1]);if(s){const r=o.querySelector(".text-truncate");r&&(r.textContent=s.content)}const i=o.querySelector(".badge"),a=o.querySelector(".conversation-meta");if(e.unread_count>0)if(i)i.textContent=e.unread_count;else{const r=document.createElement("div");r.className="badge rounded-pill bg-primary ms-auto",r.textContent=e.unread_count,a&&a.appendChild(r)}else i&&i.remove();u()}function p(e){var i,a;const n=document.getElementById("conversation-list");if(!n)return;const o=(i=e.messages)==null?void 0:i[e.messages.length-1],t=((a=e.customer)==null?void 0:a.name)||"Unknown Customer",s=document.createElement("li");s.className="chat-item pe-1 conversation-item",s.setAttribute("data-conversation-id",e.id),s.onclick=()=>selectConversation(e.id),s.innerHTML=`
        <a href="javascript:;" class="d-flex align-items-center">
            <figure class="mb-0 me-2">
                <img src="${v}" class="img-xs rounded-circle" alt="user">
                <div class="status online"></div>
            </figure>
            <div class="d-flex justify-content-between flex-grow-1 border-bottom">
                <div>
                    <p class="text-body fw-bolder">${t}</p>
                    <p class="text-muted tx-13 text-truncate">${(o==null?void 0:o.content)||"No messages yet"}</p>
                </div>
                <div class="d-flex flex-column align-items-end conversation-meta">
                    <p class="text-muted tx-13 mb-1"></p>
                    ${e.unread_count>0?`<div class="badge rounded-pill bg-primary ms-auto">${e.unread_count}</div>`:""}
                </div>
            </div>
        </a>
    `,n.insertBefore(s,n.firstChild),u()}function E(e){var t;const n=document.getElementById("conversation-list");if(!n){console.warn("Conversation list element not found");return}n.innerHTML="";const o=e==="all"?"/api/conversations":`/api/conversations?platform=${encodeURIComponent(e)}`;fetch(o,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.content)||""}}).then(s=>{if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return s.json()}).then(s=>{const i=s.data||s;if(Array.isArray(i)&&i.length===0){n.innerHTML='<li class="p-3 text-center text-muted">No conversations found</li>';return}i.forEach(a=>{p(a)}),console.log(`Loaded ${i.length} conversations for platform: ${e}`)}).catch(s=>{console.error(`Error loading conversations for platform ${e}:`,s),n.innerHTML='<li class="p-3 text-center text-muted">Error loading conversations</li>'})}function u(){const e=document.getElementById("sidebar-inbox-badge");if(!e)return;const n=document.querySelectorAll("#conversation-list .badge"),o=Array.from(n).reduce((t,s)=>{const i=parseInt(s.textContent,10);return t+(Number.isNaN(i)?0:i)},0);e.textContent=o,e.dataset.unreadCount=o,e.classList.toggle("d-none",o===0)}function T(e){const n=e.conversation;console.log("Conversation status changed:",n.status);const o=Number(window.currentConversationId||0)||null;o&&Number(n==null?void 0:n.id)}function h(e){fetch(`/api/conversations/${e}/read`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(()=>u()).catch(n=>console.error("Error marking as read:",n))}function I(){if(w("init"),!b()){d("System notifications require HTTPS or localhost.");return}Notification.permission==="default"&&!l&&(l=!0,Notification.requestPermission().catch(e=>{console.warn("Notification permission request failed:",e)}))}async function L(e,n,o=null){if(w("incoming-event"),!b()){d("System notifications are unavailable in this browser context.");return}if(Notification.permission==="default"&&!l){l=!0;try{await Notification.requestPermission()}catch(t){console.warn("Notification permission request failed during incoming event:",t)}}if(Notification.permission!=="granted"){d("Browser notifications are blocked. Allow them in site settings.");return}try{const t=new Notification(e,{body:n,icon:y,tag:o?`conversation-${o}`:void 0});t.onclick=()=>{window.focus(),t.close()},console.log("System notification sent",{title:e,conversationId:o})}catch(t){console.error("Error showing system notification:",t),d("Failed to show system notification. Check OS notification settings.")}}function b(){return"Notification"in window&&window.isSecureContext}function w(e){const n="Notification"in window?Notification.permission:"unsupported";console.log("Notification state",{context:e,permission:n,isSecureContext:window.isSecureContext,hasFocus:document.hasFocus(),hidden:document.hidden})}function d(e){g||(g=!0,console.warn("System notification unavailable:",e),m("Browser popup unavailable",e))}function m(e,n){const o=P();if(typeof bootstrap>"u"||!bootstrap.Toast){const i=document.createElement("div");i.className="alert alert-primary shadow-sm mb-2",i.innerHTML=`<strong>${e}</strong><div>${n}</div>`,o.appendChild(i),setTimeout(()=>i.remove(),3500);return}const t=document.createElement("div");t.className="toast align-items-center text-white bg-primary border-0 shadow-lg",t.setAttribute("role","status"),t.setAttribute("aria-live","assertive"),t.setAttribute("aria-atomic","true"),t.innerHTML=`
        <div class="d-flex">
            <div class="toast-body">
                <strong>${e}</strong>
                <p class="mb-0 text-truncate">${n}</p>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `,o.appendChild(t),new bootstrap.Toast(t).show(),t.addEventListener("hidden.bs.toast",()=>t.remove())}function P(){let e=document.getElementById("inbox-runtime-toast-container");return e||(e=document.createElement("div"),e.id="inbox-runtime-toast-container",e.className="toast-container position-fixed top-0 end-0 p-3",e.style.zIndex="2000",document.body.appendChild(e)),e}window.showNotification=m;window.updateSidebarUnreadBadge=u;window.markConversationAsRead=h;
